<aside class="flex flex-col h-full bg-white">
  <header class="flex border-b border-gray-200 shrink-0">
    <span class="font-semibold p-4">Wiadomości</span>
  </header>

  <nav class="flex-1 overflow-y-auto custom-scrollbar relative">

    @if (loading && conversations.length === 0) {
      @for (i of [1, 2, 3]; track i) {
        <div class="px-4 py-3 border-b border-gray-100 animate-pulse">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 bg-gray-200 rounded-full shrink-0"></div>
            <div class="flex-1 min-w-0">
              <div class="flex justify-between items-baseline mb-2">
                <div class="h-4 bg-gray-200 rounded w-1/3"></div>
                <div class="h-3 bg-gray-200 rounded w-8"></div>
              </div>
              <div class="flex justify-between items-end gap-2">
                <div class="h-3 bg-gray-200 rounded w-3/4"></div>
              </div>
            </div>
          </div>
        </div>
      }
    }

    @if (!loading && conversations.length === 0) {
      <div class="h-full flex items-center justify-center p-4">
        <app-empty-state
          title="Brak wiadomości"
          description="Napisz do sprzedającego, aby rozpocząć konwersację."
          icon="message-circle"
        >
          <a actions routerLink="/" class="px-6 py-2 bg-my text-white rounded-sm text-sm font-medium hover:bg-[#001e21] transition-colors">
            Przeglądaj ogłoszenia
          </a>
          <app-button
            routerLink="/"
          >
            Przeglądaj ogłoszenia
          </app-button>
        </app-empty-state>
      </div>
    }

    @for (chat of conversations; track chat.id) {
      <div
        (click)="openChat(chat.id)"
        routerLinkActive="bg-gray-50 border-r-4 border-r-my"
        class="cursor-pointer hover:bg-gray-100 px-4 py-3 border-b border-gray-100 transition-colors"
      >
        <div class="flex items-center gap-3">
          <div class="relative flex-shrink-0">
            <img
              [src]="chat.productImage.url || 'assets/default-product.png'"
              class="w-12 h-12 object-cover rounded-full border border-gray-100"
              [alt]="chat.productTitle"
            />
          </div>

          <div class="flex-1 min-w-0">
            <div class="flex justify-between items-baseline mb-0.5">
              <span class="font-semibold text-sm truncate pr-2">
                {{ chat.productTitle }}
              </span>
              <time class="text-[10px] text-gray-400 whitespace-nowrap">
                {{ chat.lastMessageDate | date:'HH:mm' }}
              </time>
            </div>

            @if (chat.unreadCount) {
              <div class="flex justify-between items-end gap-2">
                <p class="text-xs line-clamp-1 flex-1"
                   [class.font-bold]="chat.unreadCount > 0"
                   [class.text-gray-900]="chat.unreadCount > 0"
                   [class.text-gray-500]="chat.unreadCount === 0">
                  {{ chat.lastMessage }}
                </p>

                @if (chat.unreadCount > 0) {
                  <span class="inline-flex items-center justify-center min-w-[18px] h-[18px] px-1 text-[10px] font-bold text-white bg-my rounded-full shrink-0">
                    {{ chat.unreadCount }}
                  </span>
                }
              </div>
            }
          </div>
        </div>
      </div>
    }

    @if (hasMore && conversations.length > 0) {
      <div #sentinel class="p-4 flex justify-center">
        @if (loading) {
          <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-my"></div>
        }
      </div>
    }
  </nav>
</aside>
