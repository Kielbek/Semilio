<div class="relative w-full">
  <label class="block text-[11px] font-medium text-[#002f34] mb-2 uppercase tracking-wider">
    Kategoria
  </label>
  <div
    (click)="toggleDropdown()"
    class="w-full bg-[#f2f4f5] cursor-pointer
           rounded-t-md px-4 py-3 text-[#002f34] transition-all
           flex justify-between items-center group select-none"
    [ngClass]="{
      'border-b-2 border-[#002f34]': isOpen(),
      'opacity-50 cursor-not-z': isDisabled
    }"
  >
    <div class="flex flex-col">
      @if (!selectedPath()) {
        <span class="text-sm font-light text-gray-400">Wybierz dział</span>
      } @else {
        <span class="text-sm font-medium text-[#002f34]">{{ selectedPath() }}</span>
      }
    </div>

    <lucide-icon
      name="chevron-down"
      class="w-4 h-4 text-[#002f34] transition-transform duration-200"
      [class.rotate-180]="isOpen()"
    ></lucide-icon>
  </div>


  @if (isOpen()) {
    <div class="absolute top-full left-0 w-full z-50 bg-white border border-gray-200 rounded-b-sm shadow-xl font-sans overflow-hidden animate-in fade-in zoom-in-95 duration-100">

      @if (historyStack().length > 0) {
        <div class="bg-gray-50 border-b border-gray-100 p-3 flex items-center gap-2 text-[#002f34]">
          <button
            type="button"
            (click)="goBack()"
            class="p-1.5 hover:bg-white hover:shadow-sm rounded-full transition-all focus:outline-none flex items-center justify-center border border-transparent hover:border-gray-200"
            title="Wróć"
          >
            <lucide-icon name="arrow-left" class="w-4 h-4"></lucide-icon>
          </button>
          <span class="font-semibold text-xs uppercase tracking-wide truncate">{{ currentTitle() }}</span>
        </div>
      }

      <ul class="flex flex-col max-h-64 overflow-y-auto custom-scrollbar">
        @for (node of currentNodes(); track node.id) {
          <li
            (click)="selectNode(node)"
            class="group flex items-center justify-between px-4 py-3 cursor-pointer hover:bg-[#f8fafb] border-b border-gray-50 last:border-0 transition-colors duration-150"
          >
            <div class="flex items-center gap-3 overflow-hidden">
              @if (node.icon) {
                <lucide-icon
                  [name]="node.icon"
                  class="text-gray-400 group-hover:text-[#002f34] w-4 h-4 transition-colors"
                  [strokeWidth]="2"
                ></lucide-icon>
              }

              <span class="text-gray-600 group-hover:text-[#002f34] font-light text-sm truncate transition-colors">
                {{ node.name }}
              </span>
            </div>

            @if (node.subcategories?.length) {
              <div class="text-gray-300 group-hover:text-[#002f34] group-hover:translate-x-1 transition-all flex items-center">
                <lucide-icon name="chevron-right" class="w-4 h-4"></lucide-icon>
              </div>
            } @else if (value === node.id) {
              <lucide-icon name="check" class="w-4 h-4 text-[#002f34]"></lucide-icon>
            }
          </li>
        } @empty {
          <li class="p-6 text-center text-gray-400 text-xs font-light">Brak podkategorii</li>
        }
      </ul>

    </div>
  }
</div>
