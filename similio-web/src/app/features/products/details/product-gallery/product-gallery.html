@if (images && images.length > 0) {
  <section aria-label="Galeria zdjęć" class="bg-white rounded-sm md:p-4 max-w-6xl mx-auto shadow-sm overflow-hidden">
    <div class="grid gap-1 h-[25rem] md:h-[34rem] overflow-hidden relative"
         [ngClass]="images.length === 1 ? 'grid-cols-1' : 'grid-cols-1 md:grid-cols-2'">

      <div class="relative h-full w-full overflow-hidden bg-gray-50 flex items-center justify-center">
        <img
          [src]="images[currentIndex].url"
          [alt]="'Zdjęcie ' + (currentIndex + 1)"
          class="block max-w-full max-h-full object-contain cursor-pointer hover:opacity-95 transition-opacity md:hidden"
          (click)="openPopup(currentIndex)"
        />
        <img
          [src]="images[0].url"
          alt="Zdjęcie główne"
          class="hidden md:block w-full h-full object-cover cursor-pointer hover:opacity-95 transition-opacity"
          (click)="openPopup(0)"
        />

        @if (images.length > 1) {
          <div class="flex md:hidden absolute inset-0 items-center justify-between px-4 pointer-events-none">
            <button (click)="prevImage()" class="p-2 rounded-full bg-black/30 text-white pointer-events-auto backdrop-blur-sm active:scale-95 transition-transform">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
              </svg>
            </button>
            <button (click)="nextImage()" class="p-2 rounded-full bg-black/30 text-white pointer-events-auto backdrop-blur-sm active:scale-95 transition-transform">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
              </svg>
            </button>
          </div>

          <div class="absolute bottom-4 right-4 bg-black/50 text-white px-3 py-1 rounded-full text-sm font-medium md:hidden backdrop-blur-sm">
            {{ currentIndex + 1 }} / {{ images.length }}
          </div>
        }
      </div>

      @if (images.length > 1) {
        <div class="hidden md:grid gap-1 h-full w-full min-h-0"
             [ngClass]="getRightContainerClass()">

          @for (img of images.slice(1, 5); let i = $index; track img) {
            @let actualIndex = i + 1;
            @let isLastVisible = (images.length > 5 && i === 3);

            <div class="relative w-full h-full min-h-0 overflow-hidden group"
                 [ngClass]="getItemClass(i)">

              <ng-container *ngTemplateOutlet="imageItem; context: { src: img.url, index: actualIndex }"></ng-container>

              @if (isLastVisible) {
                <div
                  class="absolute inset-0 bg-black/50 flex items-center justify-center cursor-pointer hover:bg-black/40 transition-colors z-10"
                  (click)="openPopup(actualIndex)"
                >
                  <span class="text-white text-2xl font-semibold select-none">+{{ images.length - 5 }}</span>
                </div>
              }
            </div>
          }
        </div>
      }
    </div>
  </section>
} @else {
  <section aria-hidden="true" class="bg-white rounded-sm md:p-4 max-w-6xl mx-auto shadow-sm overflow-hidden animate-pulse">
    <div class="grid gap-1 h-[25rem] md:h-[34rem] grid-cols-1 md:grid-cols-2">

      <div class="w-full h-full bg-gray-200"></div>

      <div class="hidden md:grid grid-cols-2 grid-rows-2 gap-1 h-full w-full">
        <div class="bg-gray-100 w-full h-full"></div>
        <div class="bg-gray-100 w-full h-full"></div>
        <div class="bg-gray-100 w-full h-full"></div>
        <div class="bg-gray-100 w-full h-full"></div>
      </div>
    </div>
  </section>
}

<ng-template #imageItem let-src="src" let-index="index">
  <img
    [src]="src"
    [alt]="'Zdjęcie ' + (index + 1)"
    class="block w-full h-full object-cover cursor-pointer hover:opacity-95 transition-opacity"
    (click)="openPopup(index)"
  />
</ng-template>

<app-popup [isOpen]="isPopupOpen" (close)="isPopupOpen = !isPopupOpen">
  <app-image-gallery [images]="images" [startIndex]="selectedIndex"></app-image-gallery>
</app-popup>
